<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN">
<!-- Created by htmlize-1.56 in css mode. -->
<html>
  <head>
    <title>beamer-dual-format.org</title>
    <style type="text/css">
    <!--
      body {
        color: #d6d6d4;
        background-color: #161719;
      }
      .bold {
        /* bold */
        font-weight: bold;
      }
      .builtin {
        /* font-lock-builtin-face */
        color: #fd971f;
      }
      .comment {
        /* font-lock-comment-face */
        color: #696969;
      }
      .comment-delimiter {
        /* font-lock-comment-delimiter-face */
        color: #696969;
      }
      .constant {
        /* font-lock-constant-face */
        color: #fd971f;
      }
      .doc {
        /* font-lock-doc-face */
        color: #7f7f80;
      }
      .font-latex-italic {
        /* font-latex-italic-face */
        font-style: italic;
      }
      .font-latex-sectioning-2 {
        /* font-latex-sectioning-2-face */
        color: #9c91e4;
      }
      .font-latex-sectioning-3 {
        /* font-latex-sectioning-3-face */
        color: #67addf;
      }
      .font-latex-sedate {
        /* font-latex-sedate-face */
        color: #d3d3d3;
      }
      .function-name {
        /* font-lock-function-name-face */
        color: #b6e63e;
      }
      .highlight-numbers-number {
        /* highlight-numbers-number */
        color: #9c91e4;
        font-weight: bold;
      }
      .highlight-quoted-quote {
        /* highlight-quoted-quote */
        color: #9c91e4;
      }
      .highlight-quoted-symbol {
        /* highlight-quoted-symbol */
        color: #66d9ef;
      }
      .italic {
        /* italic */
        font-style: italic;
      }
      .kc-org-link-url {
        /* kc-org-link-url */
        color: #d02090;
        text-decoration: underline;
      }
      .keyword {
        /* font-lock-keyword-face */
        color: #eb4509;
      }
      .negation-char {
        /* font-lock-negation-char-face */
        color: #9c91e4;
        font-weight: bold;
      }
      .org-block {
        /* org-block */
        background-color: #000000;
      }
      .org-block-begin-line {
        /* org-block-begin-line */
        color: #696969;
      }
      .org-block-end-line {
        /* org-block-end-line */
        color: #696969;
      }
      .org-document-info {
        /* org-document-info */
        color: #fd971f;
      }
      .org-document-info-keyword {
        /* org-document-info-keyword */
        color: #555556;
      }
      .org-document-title {
        /* org-document-title */
        color: #fd971f;
        font-weight: bold;
      }
      .org-drawer {
        /* org-drawer */
        color: #cd3278;
      }
      .org-footnote {
        /* org-footnote */
        color: #fd971f;
      }
      .org-level-1 {
        /* org-level-1 */
        color: #eb4509;
        font-weight: bold;
      }
      .org-level-2 {
        /* org-level-2 */
        color: #f0b144;
        font-weight: bold;
      }
      .org-level-3 {
        /* org-level-3 */
        color: #8ec298;
        font-weight: bold;
      }
      .org-list-dt {
        /* org-list-dt */
        color: #e2c770;
      }
      .org-meta-line {
        /* org-meta-line */
        color: #7f7f80;
      }
      .org-property-value {
        /* org-property-value */
        color: #7f7f80;
      }
      .org-special-keyword {
        /* org-special-keyword */
        color: #7f7f80;
      }
      .org-superstar-header-bullet {
      }
      .org-superstar-leading {
        /* org-superstar-leading */
        color: #bebebe;
        background-color: #010000;
      }
      .org-table {
        /* org-table */
        color: #9c91e4;
      }
      .org-verbatim {
        /* org-verbatim */
        color: #b6e63e;
      }
      .rainbow-delimiters-depth-1 {
        /* rainbow-delimiters-depth-1-face */
        color: #eb4509;
      }
      .rainbow-delimiters-depth-2 {
        /* rainbow-delimiters-depth-2-face */
        color: #fd971f;
      }
      .rainbow-delimiters-depth-3 {
        /* rainbow-delimiters-depth-3-face */
        color: #b6e63e;
      }
      .regexp-grouping-backslash {
        /* font-lock-regexp-grouping-backslash */
        color: #9c91e4;
        font-weight: bold;
      }
      .regexp-grouping-construct {
        /* font-lock-regexp-grouping-construct */
        color: #9c91e4;
        font-weight: bold;
      }
      .string {
        /* font-lock-string-face */
        color: #e2c770;
      }
      .variable-name {
        /* font-lock-variable-name-face */
        color: #fd971f;
      }
      .whitespace-tab {
        /* whitespace-tab */
        color: #4e4e4e;
        background-color: #2d2e2e;
      }

      a {
        color: inherit;
        background-color: inherit;
        font: inherit;
        text-decoration: inherit;
      }
      a:hover {
        text-decoration: underline;
      }
    -->
    </style>
  </head>
  <body>
    <pre>
<span class="org-document-info-keyword">#+TITLE:</span>     <span class="org-document-title">Using Beamer export to produce slideshows and article-style handouts from the same org source
</span><span class="org-document-info-keyword">#+AUTHOR:</span>    <span class="org-document-info">James Harkins
</span><span class="org-document-info-keyword">#+EMAIL:</span>     <span class="org-document-info">
</span><span class="org-document-info-keyword">#+DATE:</span>      <span class="org-document-info">
</span><span class="org-meta-line">#+LANGUAGE:  en</span>
<span class="org-meta-line">#+OPTIONS:   H:3 num:nil toc:t \n:nil ::t |:t ^:t -:t f:t *:t</span>
<span class="org-meta-line">#+OPTIONS:   tex:t d:(HIDE) tags:not-in-toc</span>
<span class="org-meta-line">#+STARTUP:   fold</span>
<span class="org-meta-line">#+CATEGORY:   worg</span>

<span class="org-level-1"><span class="org-superstar-header-bullet">*</span></span><span class="org-level-1"> Project overview
</span>
The project is training material for a one-week intensive workshop in audio 
synthesis and live-performance control in the SuperCollider programming 
language. The workshop was commissioned by CHEARS, the China 
ElectroAcoustic Resource Survey, and will be given first in Shenyang, PRC.

I wanted to have thorough presentation slides available, for some kinds of 
explanation that are difficult otherwise, and also give a PDF book to 
workshop attendees for their future reference. During the writing process, 
the book became more important, as a way to provide copyright-free 
tutorials for translation into Chinese. The book eventually grew to 237 
pages (with, admittedly, more white space per page than a standard prose 
layout), rendered from 10849 lines of LaTeX code, all of which were 
generated directly by the org Beamer exporter with no manual edits to any 
of the <span class="org-verbatim">tex</span> files.

Achieving that required some ingenuity in both org mode and LaTeX. This 
worg page documents the project's design and implementation.

<span class="org-level-1"><span class="org-superstar-header-bullet">*</span></span><span class="org-level-1"> Requirements
</span>
<span class="org-list-dt">-</span> One org source to produce slideshows and printed material.
  <span class="org-list-dt">-</span> Beamer export for both formats.
    <span class="org-list-dt">-</span> Normal <span class="italic">beamer</span> document class for slides.
    <span class="org-list-dt">-</span> Document class <span class="italic">article</span> for the book, with
      <span class="org-verbatim">\usepackage{beamerarticle}</span> in the preamble.
  <span class="org-list-dt">-</span> Header files to determine PDF layout.
  <span class="org-list-dt">-</span> Additional explanatory text that will be omitted from slideshows.
    <span class="org-list-dt">-</span> Use the beamer class option <span class="italic">ignorenonframetext</span> for slides.
    <span class="org-list-dt">-</span> Put notes under frame-level headings, with the beamer tag
      <span class="org-verbatim">B_ignoreheading</span>.

<span class="org-list-dt">-</span> Indexed glossaries of terms, classes and methods, without writing
  cumbersome LaTeX syntax for the glossaries package.
  <span class="org-list-dt">-</span> Keep glossary definitions in org tables.
  <span class="org-list-dt">-</span> Convert to LaTeX syntax using emacs-lisp source blocks.
  <span class="org-list-dt">-</span> Convert only once in the book combining all chapters, but once per slideshow.

<span class="org-list-dt">-</span> Extract captioned source blocks into plain-text files for SuperCollider.
  <span class="org-list-dt">-</span> <span class="org-verbatim">org-element-map</span> did all the hard work.

<span class="org-level-1"><span class="org-superstar-header-bullet">*</span></span><span class="org-level-1"> Implementation
</span>
<span class="org-superstar-leading">*</span><span class="org-level-2"><span class="org-superstar-header-bullet">*</span></span><span class="org-level-2"> One source: File structure
</span>The LaTeX preamble controls the output format; so, to have different output 
from the same org source, the preamble must be separate from the content. 
Here, we have two headers:

<span class="org-list-dt">-</span> <span class="org-verbatim">slidehead.org</span>, which specifies the document class <span class="italic">beamer</span> with
  the <span class="italic">presentation</span> option.
<span class="org-list-dt">-</span> <span class="org-verbatim">printhead2.org</span>, which specifies the <span class="italic">article</span> class and adds the
  <span class="italic">beamerarticle</span> package so that the article class can interpret
  beamer formatting commands.

Other formatting differences are implemented here. For instance, inline 
code fragments are colored green in the slides, but remain black in the 
article.

Header files contain nothing specific to any chapter, and content files are 
strictly content, no formatting definitions. Neither of these are exported 
directly. The export files provide the title and author fields, and include 
(<span class="org-verbatim">#+INCLUDE:</span>) the appropriate header and content files. They also include 
the glossary file; details to follow.

<span class="org-meta-line">#+name: slidehead</span>
<span class="org-meta-line">#+caption:</span> <span class="org-block">Primary export options for slideshow format.</span>
<span class="org-block-begin-line">#+begin_src org
</span><span class="org-block">  ,#+startup: beamer
  ,#+LaTeX_CLASS: beamer
  ,#+LaTeX_CLASS_OPTIONS: [ignorenonframetext,presentation]
  ,#+BEAMER_THEME: default
</span><span class="org-block-end-line">#+end_src
</span>
<span class="org-meta-line">#+name: printhead</span>
<span class="org-meta-line">#+caption:</span> <span class="org-block">Primary export options for article format.</span>
<span class="org-block-begin-line">#+begin_src org
</span><span class="org-block">  ,#+startup: beamer
  ,#+LaTeX_CLASS: article
  ,#+LaTeX_CLASS_OPTIONS: [a4paper,twoside,11pt]
  ,#+BEAMER_THEME: default
  ,#+LATEX_HEADER: \usepackage{beamerarticle}
</span><span class="org-block-end-line">#+end_src
</span>
<span class="org-meta-line">#+name: contents</span>
<span class="org-meta-line">#+caption:</span> <span class="org-block">Beginning of one of the contents files.</span>
<span class="org-block-begin-line">#+begin_src org
</span><span class="org-block">  ,#+startup: beamer
  
  ,* Workshop introduction
  ,** Workshop introduction
  ,*** Workshop goals
  ,**** Teach synthesis techniques by experimentation
       </span><span class="org-list-dt"><span class="org-block"><span class="org-list-dt">-</span></span></span><span class="org-block"> SC lets us take apart synthesizer components, and put them back together.
       </span><span class="org-list-dt"><span class="org-block"><span class="org-list-dt">-</span></span></span><span class="org-block"> SC's /</span><span class="org-block"><span class="italic">Just-In-Time library</span></span><span class="org-block">/ makes it easy to re-patch components interactively.
  ,**** Teach techniques for live control and performance
       </span><span class="org-list-dt"><span class="org-block"><span class="org-list-dt">-</span></span></span><span class="org-block"> Control by graphic interfaces and external devices.
       </span><span class="org-list-dt"><span class="org-block"><span class="org-list-dt">-</span></span></span><span class="org-block"> End goal: A group composition, to perform together.
  ,**** *</span><span class="org-block"><span class="bold">Have fun programming!</span></span><span class="org-block">*
       </span><span class="org-list-dt"><span class="org-block"><span class="org-list-dt">-</span></span></span><span class="org-block"> Emphasis on /</span><span class="org-block"><span class="italic">play</span></span><span class="org-block">/ over /</span><span class="org-block"><span class="italic">correctness</span></span><span class="org-block">/.
</span><span class="org-block-end-line">#+end_src
</span>
<span class="org-meta-line">#+name: slideExport</span>
<span class="org-meta-line">#+caption:</span> <span class="org-block">The slideshow document that is actually exported.</span>
<span class="org-block-begin-line">#+begin_src org
</span><span class="org-block">  ,#+startup: beamer
  
  ,#+TITLE: SuperCollider Week, Day 1 \\ Introductory SC, Synthesis and Sequencing
  ,#+DATE: \today
  ,#+AUTHOR: H. James Harkins
  
  ,#+INCLUDE: "../slidehead.org"
  ,#+include: "../glossary.org"
  
  ,#+include: "./01-contents.org" :minlevel 1
</span><span class="org-block-end-line">#+end_src
</span>
I settled on a project layout like this:

<span class="org-list-dt">-</span> <span class="org-verbatim">shows/</span> directory
  <span class="org-list-dt">-</span> <span class="org-verbatim">slidehead.org</span>: LaTeX preamble for Beamer's presentation style
  <span class="org-list-dt">-</span> <span class="org-verbatim">printhead2.org</span>: Preamble for the article document class, with the beamerarticle package
  <span class="org-list-dt">-</span> <span class="org-verbatim">glossaries.org</span>: Tables of glossary definitions, and emacs-lisp source blocks for conversion
  <span class="org-list-dt">-</span> <span class="org-verbatim">01-intro/</span> directory
    <span class="org-list-dt">-</span> <span class="org-verbatim">01-contents.org</span>: Slide contents, no header info at all
    <span class="org-list-dt">-</span> <span class="org-verbatim">01-slideshow.org</span>: Defines this chapter's header (title,
      author, etc.), includes <span class="org-verbatim">slidehead.org</span>, <span class="org-verbatim">glossaries.org</span> and
      <span class="org-verbatim">01-contents.org</span>
    <span class="org-list-dt">-</span> <span class="org-verbatim">img/</span> directory (png and PDF files for Part I)
  <span class="org-list-dt">-</span> <span class="org-verbatim">02-synth/</span> directory, structured like <span class="org-verbatim">01</span>
    Similar directories for chapters 3--6
  <span class="org-list-dt">-</span> <span class="org-verbatim">full-article/</span> directory
    <span class="org-list-dt">-</span> <span class="org-verbatim">full-article.org</span>: Defines title etc., includes
      <span class="org-verbatim">printhead2.org</span>, <span class="org-verbatim">glossaries.org</span>, <span class="italic">all</span> content files and
      additional sections at the end for glossaries

To render the slides for day 1, I visit <span class="org-verbatim">01-slideshow.org</span> in Emacs
and export to Beamer. The print- or tablet-ready book comes from
<span class="org-verbatim">full-article.org</span>. This should also be exported by the Beamer
backend, even though the document class is <span class="italic">article</span>. This makes
sense, however; the org source uses Beamer-specific markup which the
normal LaTeX backend will not understand. It's LaTeX itself that
"converts" the format to article through inclusion of the
<span class="italic">beamerarticle</span> package.

<span class="org-superstar-leading">**</span><span class="org-level-3"><span class="org-superstar-header-bullet">*</span></span><span class="org-level-3"> Explanatory prose
</span>Slides minimize the amount of text on one screen, by using shorter, simpler 
sentences in outline layouts. Some issues call for a narrative discussion 
in prose. Prose should <span class="italic">not</span> be shown in a slide presentation!

Beamer can omit text from a presentation using the document class option 
<span class="italic">ignorenonframetext</span>. Text that appears outside of a <span class="italic">frame</span> environment 
will be suppressed. The trick is to get org to export text outside of a 
frame, without affecting sectioning.

Org creates a frame when it encounters a headline at the level defined by 
the <span class="org-verbatim">H:</span> export option, and it closes the frame at the next headline at 
this level or higher. This project uses <span class="org-verbatim">H:3</span>, so normally, the contents 
under every third-level headline will be enclosed in begin/end frame tags.

If the headline has the Beamer-specific tag <span class="org-verbatim">:B_ignoreheading:</span>, then the 
heading <span class="italic">and</span> the begin/end frame commands are suppressed, but all the 
content appears.

<span class="org-meta-line">#+name: prose_source</span>
<span class="org-meta-line">#+caption:</span> <span class="org-block">Org source, including a paragraph that should appear outside of a frame.</span>
<span class="org-block-begin-line">#+begin_src org
</span><span class="org-block">  ,#+OPTIONS: H:3 texht:t
  ,#+LaTeX_CLASS: beamer
  ,#+LaTeX_CLASS_OPTIONS: [ignorenonframetext,presentation]
  
  ,* Section head
  ,** Subsection head
  ,*** Frame title
  ,**** Block header
       Text.
       </span><span class="org-list-dt"><span class="org-block"><span class="org-list-dt">-</span></span></span><span class="org-block"> Bullet point.
  ,*** More explanation coming                                 :B_ignoreheading:
      </span><span class="org-block"><span class="org-drawer">:PROPERTIES:</span></span><span class="org-block">
      </span><span class="org-block"><span class="org-special-keyword">:BEAMER_env:</span></span><span class="org-block"> </span><span class="org-block"><span class="org-property-value">ignoreheading</span></span><span class="org-block">
      </span><span class="org-block"><span class="org-drawer">:END:</span></span><span class="org-block">
      Here, we explain points from the previous frame in more
      detail. This text will always appear in the exported LaTeX, but
      the /</span><span class="org-block"><span class="italic">ignorenonframetext</span></span><span class="org-block">/ class option will prevent it from being
      rendered in the presentation.
</span><span class="org-block-end-line">#+end_src
</span>
<span class="org-meta-line">#+name: prose_exported</span>
<span class="org-meta-line">#+caption:</span> <span class="org-block">The LaTeX export result. Note the absence of begin/end frame commands around the free-standing paragraph.</span>
<span class="org-block-begin-line">#+begin_src latex
</span><span class="org-block"><span class="comment-delimiter">% </span></span><span class="org-block"><span class="comment">Created 2014-05-01 Thu 16:05
</span></span><span class="org-block"><span class="font-latex-sedate"><span class="keyword">\documentclass</span></span></span><span class="org-block">[</span><span class="org-block"><span class="variable-name">ignorenonframetext,presentation</span></span><span class="org-block">]{</span><span class="org-block"><span class="function-name">beamer</span></span><span class="org-block">}
</span><span class="org-block"><span class="font-latex-sedate"><span class="keyword">\begin</span></span></span><span class="org-block">{</span><span class="org-block"><span class="function-name">document</span></span><span class="org-block">}

</span><span class="org-block"><span class="font-latex-sedate"><span class="keyword">\section</span></span></span><span class="org-block">{</span><span class="org-block"><span class="font-latex-sectioning-2">Section head</span></span><span class="org-block">}
</span><span class="org-block"><span class="font-latex-sedate"><span class="keyword">\label</span></span></span><span class="org-block">{</span><span class="org-block"><span class="constant">sec-1</span></span><span class="org-block">}
</span><span class="org-block"><span class="font-latex-sedate"><span class="keyword">\subsection</span></span></span><span class="org-block">{</span><span class="org-block"><span class="font-latex-sectioning-3">Subsection head</span></span><span class="org-block">}
</span><span class="org-block"><span class="font-latex-sedate"><span class="keyword">\label</span></span></span><span class="org-block">{</span><span class="org-block"><span class="constant">sec-1-1</span></span><span class="org-block">}
</span><span class="org-block"><span class="font-latex-sedate"><span class="keyword">\begin</span></span></span><span class="org-block">{</span><span class="org-block"><span class="function-name">frame</span></span><span class="org-block">}[label=sec-1-1-1]{Frame title}
</span><span class="org-block"><span class="font-latex-sedate"><span class="keyword">\begin</span></span></span><span class="org-block">{</span><span class="org-block"><span class="function-name">block</span></span><span class="org-block">}{Block header}
Text.
</span><span class="org-block"><span class="font-latex-sedate"><span class="keyword">\begin</span></span></span><span class="org-block">{</span><span class="org-block"><span class="function-name">itemize</span></span><span class="org-block">}
</span><span class="org-block"><span class="font-latex-sedate"><span class="keyword">\item</span></span></span><span class="org-block"> Bullet point.
</span><span class="org-block"><span class="font-latex-sedate"><span class="keyword">\end</span></span></span><span class="org-block">{</span><span class="org-block"><span class="function-name">itemize</span></span><span class="org-block">}
</span><span class="org-block"><span class="font-latex-sedate"><span class="keyword">\end</span></span></span><span class="org-block">{</span><span class="org-block"><span class="function-name">block</span></span><span class="org-block">}
</span><span class="org-block"><span class="font-latex-sedate"><span class="keyword">\end</span></span></span><span class="org-block">{</span><span class="org-block"><span class="function-name">frame</span></span><span class="org-block">}

Here, we explain points from the previous frame in more
detail. This text will always appear in the exported </span><span class="org-block"><span class="font-latex-sedate"><span class="keyword">\LaTeX</span></span></span><span class="org-block">{}, but
the </span><span class="org-block"><span class="font-latex-sedate"><span class="keyword">\emph</span></span></span><span class="org-block">{</span><span class="org-block"><span class="font-latex-italic">ignorenonframetext</span></span><span class="org-block">} class option will prevent it from being
rendered in the presentation.
</span><span class="org-block"><span class="font-latex-sedate"><span class="keyword">\end</span></span></span><span class="org-block">{</span><span class="org-block"><span class="function-name">document</span></span><span class="org-block">}
</span><span class="org-block-end-line">#+end_src
</span>
<span class="org-superstar-leading">**</span><span class="org-level-3"><span class="org-superstar-header-bullet">*</span></span><span class="org-level-3"> Problem: Position of </span><span class="org-level-3"><span class="org-verbatim">\maketitle</span></span><span class="org-level-3"> command
</span>
Because of <span class="italic">ignorenonframetext</span>, the LaTeX <span class="org-verbatim">\maketitle</span> command must appear 
in a frame for the slideshows. But, it should <span class="italic">not</span> be in a frame for the 
article. Further, we can't distinguish between presentation and article 
based on the org export backend, because both are exported by the Beamer 
backend.

In my environment, I used a hack that assumes Beamer has been added to
<span class="org-verbatim">org-latex-classes</span> under the exact string "beamer." This is not
ideal, because a user might have added a custom class under a
different name. Nicolas Goaziou proposed an alternate approach using
regular expressions, but I didn't implement it in my environment.

This code snippet should replace the expression following the comment
<span class="org-verbatim">;; 10. Title command</span> in the function <span class="org-verbatim">org-beamer-template</span>, defined
in ox-beamer.el.

<span class="org-meta-line">#+name: maketitlehack</span>
<span class="org-meta-line">#+caption:</span> <span class="org-block">Hack to put the maketitle command in a frame for the beamer class only.</span>
<span class="org-block-begin-line">#+begin_src emacs-lisp
</span><span class="org-block">       </span><span class="org-block"><span class="comment-delimiter">;; </span></span><span class="org-block"><span class="comment">10. Title command.
</span></span><span class="org-block">       </span><span class="org-block"><span class="rainbow-delimiters-depth-1">(</span></span><span class="org-block"><span class="keyword">let</span></span><span class="org-block"> </span><span class="org-block"><span class="rainbow-delimiters-depth-2">(</span></span><span class="org-block"><span class="rainbow-delimiters-depth-3">(</span></span><span class="org-block">titlecmd </span><span class="org-block"><span class="rainbow-delimiters-depth-1">(</span></span><span class="org-block"><span class="function-name">org-element-normalize-string</span></span><span class="org-block">
        </span><span class="org-block"><span class="rainbow-delimiters-depth-2">(</span></span><span class="org-block"><span class="keyword">cond</span></span><span class="org-block"> </span><span class="org-block"><span class="rainbow-delimiters-depth-3">(</span></span><span class="org-block"><span class="rainbow-delimiters-depth-1">(</span></span><span class="org-block"><span class="constant">string=</span></span><span class="org-block"> </span><span class="org-block"><span class="string">""</span></span><span class="org-block"> title</span><span class="org-block"><span class="rainbow-delimiters-depth-1">)</span></span><span class="org-block"> nil</span><span class="org-block"><span class="rainbow-delimiters-depth-3">)</span></span><span class="org-block">
              </span><span class="org-block"><span class="rainbow-delimiters-depth-3">(</span></span><span class="org-block"><span class="rainbow-delimiters-depth-1">(</span></span><span class="org-block"><span class="constant">not</span></span><span class="org-block"> </span><span class="org-block"><span class="rainbow-delimiters-depth-2">(</span></span><span class="org-block"><span class="constant">stringp</span></span><span class="org-block"> </span><span class="org-block"><span class="variable-name">org-latex-title-command</span></span><span class="org-block"><span class="rainbow-delimiters-depth-2">)</span></span><span class="org-block"><span class="rainbow-delimiters-depth-1">)</span></span><span class="org-block"> nil</span><span class="org-block"><span class="rainbow-delimiters-depth-3">)</span></span><span class="org-block">
              </span><span class="org-block"><span class="rainbow-delimiters-depth-3">(</span></span><span class="org-block"><span class="rainbow-delimiters-depth-1">(</span></span><span class="org-block"><span class="constant">string-match</span></span><span class="org-block"> </span><span class="org-block"><span class="string">"</span></span><span class="org-block"><span class="string"><span class="regexp-grouping-backslash">\\</span></span></span><span class="org-block"><span class="string"><span class="regexp-grouping-construct">(?:</span></span></span><span class="org-block"><span class="string">[</span></span><span class="org-block"><span class="string"><span class="negation-char">^</span></span></span><span class="org-block"><span class="string">%]</span></span><span class="org-block"><span class="string"><span class="regexp-grouping-backslash">\\</span></span></span><span class="org-block"><span class="string"><span class="regexp-grouping-construct">|</span></span></span><span class="org-block"><span class="string">^</span></span><span class="org-block"><span class="string"><span class="regexp-grouping-backslash">\\</span></span></span><span class="org-block"><span class="string"><span class="regexp-grouping-construct">)</span></span></span><span class="org-block"><span class="string">%s"</span></span><span class="org-block">
                             </span><span class="org-block"><span class="variable-name">org-latex-title-command</span></span><span class="org-block"><span class="rainbow-delimiters-depth-1">)</span></span><span class="org-block">
               </span><span class="org-block"><span class="rainbow-delimiters-depth-1">(</span></span><span class="org-block"><span class="constant">format</span></span><span class="org-block"> </span><span class="org-block"><span class="variable-name">org-latex-title-command</span></span><span class="org-block"> title</span><span class="org-block"><span class="rainbow-delimiters-depth-1">)</span></span><span class="org-block"><span class="rainbow-delimiters-depth-3">)</span></span><span class="org-block">
              </span><span class="org-block"><span class="rainbow-delimiters-depth-3">(</span></span><span class="org-block">t </span><span class="org-block"><span class="variable-name">org-latex-title-command</span></span><span class="org-block"><span class="rainbow-delimiters-depth-3">)</span></span><span class="org-block"><span class="rainbow-delimiters-depth-2">)</span></span><span class="org-block"><span class="rainbow-delimiters-depth-1">)</span></span><span class="org-block"><span class="rainbow-delimiters-depth-3">)</span></span><span class="org-block"><span class="rainbow-delimiters-depth-2">)</span></span><span class="org-block">
         </span><span class="org-block"><span class="rainbow-delimiters-depth-2">(</span></span><span class="org-block"><span class="keyword">if</span></span><span class="org-block"> </span><span class="org-block"><span class="rainbow-delimiters-depth-3">(</span></span><span class="org-block"><span class="constant">string=</span></span><span class="org-block"> </span><span class="org-block"><span class="rainbow-delimiters-depth-1">(</span></span><span class="org-block"><span class="constant">plist-get</span></span><span class="org-block"> info </span><span class="org-block"><span class="builtin">:latex-class</span></span><span class="org-block"><span class="rainbow-delimiters-depth-1">)</span></span><span class="org-block"> </span><span class="org-block"><span class="string">"beamer"</span></span><span class="org-block"><span class="rainbow-delimiters-depth-3">)</span></span><span class="org-block">
             </span><span class="org-block"><span class="rainbow-delimiters-depth-3">(</span></span><span class="org-block"><span class="constant">format</span></span><span class="org-block"> </span><span class="org-block"><span class="string">"\\begin{frame}%s\\end{frame}"</span></span><span class="org-block"> titlecmd</span><span class="org-block"><span class="rainbow-delimiters-depth-3">)</span></span><span class="org-block">
           titlecmd</span><span class="org-block"><span class="rainbow-delimiters-depth-2">)</span></span><span class="org-block"><span class="rainbow-delimiters-depth-1">)</span></span><span class="org-block">
</span><span class="org-block-end-line">#+end_src
</span>
<span class="org-superstar-leading">**</span><span class="org-level-3"><span class="org-superstar-header-bullet">*</span></span><span class="org-level-3"> Problem: Relative links to images
</span>
Image files are stored in <span class="org-verbatim">img/</span> directories under the directory for each 
part. The images must also be accessible from <span class="org-verbatim">full-article/</span>, so simple 
links of the form <span class="org-verbatim">./img/filename</span> will not work. Instead, this form of 
link handles both export locations: <span class="org-verbatim">../01-intro/img/filename</span>.

<span class="org-superstar-leading">*</span><span class="org-level-2"><span class="org-superstar-header-bullet">*</span></span><span class="org-level-2"> Glossaries
</span>The LaTeX <span class="italic">glossaries</span> package handled all my requirements: multiple 
glossaries for different categories of terms and automatic indexing of 
references to terms in the text. The syntax of the \newglossaryentry 
command is more verbose than I wanted to manage by hand. Org tables are a 
useful alternative.

I divided glossary entries into four categories: terms and concepts, unit 
generators, other classes, and methods. I used two table structures:

<span class="org-list-dt">-</span> For UGens: Category (not used), name, description, and list of inputs.
<span class="org-list-dt">-</span> Others: Term, plural form, description.

The two structures called for two lisp functions; they are essentially the 
same except for the strings generated and the handling of table rows. The 
non-UGen function includes arguments for the table and identifiers to embed 
in the LaTeX syntax, to be supplied in the <span class="org-verbatim">#+CALL</span> lines.

<span class="org-meta-line">#+name: glossaryTable</span>
<span class="org-meta-line">#+caption:</span> <span class="org-block">Part of a glossary table.</span>
<span class="org-block-begin-line">#+begin_src org
</span><span class="org-block">  ,#+name: gloss
  </span><span class="org-block"><span class="org-table">| Term  | Plural  | Description                                                                                              |</span></span><span class="org-block">
  </span><span class="org-block"><span class="org-table">|-------+---------+----------------------------------------------------------------------------------------------------------|</span></span><span class="org-block">
  </span><span class="org-block"><span class="org-table">| ADSR  |         | An Attack-Decay-Sustain-Release envelope                                                                 |</span></span><span class="org-block">
  </span><span class="org-block"><span class="org-table">| proxy | proxies | A placeholder that allows you to define connections between modules independent of each module's content |</span></span><span class="org-block">
</span><span class="org-block-end-line">#+end_src
</span>
<span class="org-meta-line">#+name: glossaryFunction</span>
<span class="org-meta-line">#+caption:</span> <span class="org-block">Function to convert a normal (non-UGen) glossary table into LaTeX markup.</span>
<span class="org-block-begin-line">#+begin_src org
</span><span class="org-block">  ,#+name: makegloss
  ,#+begin_src emacs-lisp :var tbl=gloss glosstype='nil :exports none :results value latex
    (let ((str "")
          (gltype (if glosstype (format "type=%s," glosstype) "")))
      (pop tbl)
      (pop tbl)
      (while tbl
        (let ((item (pop tbl)))
          (setq str
                (concat str
                        (format "\\newglossaryentry{%s}{%sname={%s},%sdescription={%s}}\n"
                                (car item)
                                gltype
                                (pop item)
                                (let ((plural (pop item)))
                                  (if (string= plural "")
                                      ""
                                    (format "plural={%s}," plural)))
                                (car item))))))
      str)
  ,#+end_src
</span><span class="org-block-end-line">#+end_src
</span>
<span class="org-superstar-leading">**</span><span class="org-level-3"><span class="org-superstar-header-bullet">*</span></span><span class="org-level-3"> Problem: Redundant glossary export in the full article
</span>
The two output styles raise some conflicting requirements:

<span class="org-list-dt">-</span> <span class="bold">Presentation style:</span> Because of the <span class="italic">ignorenonframetext</span> class
  option, the <span class="org-verbatim">\newglossaryentry</span> commands must appear within a
  frame. They cannot go into <span class="org-verbatim">slidehead.org</span>. Each separate contents
  file must include its own calls to the glossary functions.

<span class="org-list-dt">-</span> <span class="bold">Article style:</span> The contents files are included in the same export
  file -- which would produce redundant copies of the glossary
  entries.

This calls for <span class="italic">conditional execution</span> of the Babel calls. A
not-quite-obvious feature of Babel properties is that they may be
Emacs-lisp expressions. That leads to a solution: Use a code block at
the beginning of the <span class="org-verbatim">0*-slideshow.org</span> and <span class="org-verbatim">full-article.org</span> files
to set a flag, <span class="org-verbatim">hjh-exporting-slides</span>.

<span class="org-meta-line">#+name: setflag-slides</span>
<span class="org-meta-line">#+caption:</span> <span class="org-block">Setting the slideshow flag for slideshows.</span>
<span class="org-block-begin-line">#+begin_src org
</span><span class="org-block">  ,#+name: set-slide-flag
  ,#+begin_src emacs-lisp :exports results :results value latex
  (setq hjh-exporting-slides 't)
  ""
  ,#+end_src
</span><span class="org-block-end-line">#+end_src
</span>
<span class="org-meta-line">#+name: setflag-article</span>
<span class="org-meta-line">#+caption:</span> <span class="org-block">Setting the slideshow flag for the article.</span>
<span class="org-block-begin-line">#+begin_src org
</span><span class="org-block">  ,#+name: set-slide-flag
  ,#+begin_src emacs-lisp :exports results :results value latex
  (setq hjh-exporting-slides nil)
  ""
  ,#+end_src
</span><span class="org-block-end-line">#+end_src
</span>
Then, the <span class="org-verbatim">#+CALL:</span> lines can use an <span class="org-verbatim">(if...)</span> expression to decide
whether the <span class="org-verbatim">:exports</span> property should be "results" or "none." If this
result is "none," then Babel skips that call. So, each glossary
section evaluates only once per export, no matter how many contents
files are included.

<span class="org-meta-line">#+name: call-slides</span>
<span class="org-meta-line">#+caption:</span> <span class="org-block">Calling the glossary function in a slideshow.</span>
<span class="org-block-begin-line">#+begin_src org
</span><span class="org-block">  ,#+call: makegloss :exports (if hjh-exporting-slides "results" "none") :results value latex
  ,#+results: makegloss
</span><span class="org-block-end-line">#+end_src
</span>
<span class="org-meta-line">#+name: call-article</span>
<span class="org-meta-line">#+caption:</span> <span class="org-block">Calling the glossary function in the article.</span>
<span class="org-block-begin-line">#+begin_src org
</span><span class="org-block">  ,#+name: makegloss_art
  ,#+call: makegloss :exports (if hjh-exporting-slides "none" "results") :results value latex
  ,#+results: makegloss_art
</span><span class="org-block-end-line">#+end_src
</span>
<span class="org-superstar-leading">**</span><span class="org-level-3"><span class="org-superstar-header-bullet">*</span></span><span class="org-level-3"> Output format
</span>By default, org treats CALL results as example blocks. In LaTeX
export, example blocks are wrapped in a <span class="italic">verbatim</span> environment. These
functions return LaTeX syntax, to embed into the LaTeX document as
is. Adding "value latex" to the <span class="org-verbatim">:results</span> property takes care of
that.

<span class="org-superstar-leading">*</span><span class="org-level-2"><span class="org-superstar-header-bullet">*</span></span><span class="org-level-2"> Extraction of captioned source code blocks
</span>I also wanted to provide SuperCollider code files containing the
numbered examples from the text. That means iterating over the source
code blocks, and collecting the code from every block that has a
caption. (Code blocks without a caption do not receive a listing
number.)

The Swiss-army-knife function <span class="org-verbatim">org-element-map</span> handles the iteration
in a way that is absurdly simple to use: first, use
<span class="org-verbatim">org-element-parse-buffer</span> to get an object structure for the org
buffer's contents, and then call <span class="org-verbatim">org-element-map</span> on the parsed tree,
filtering on <span class="org-verbatim">'src-block</span>.

Each element identified this way is rather complex. Extensive tests
with Emacs step debugging helped me find several processing steps:

<span class="org-list-dt">1.</span> The interesting bit of the source-block element is the second item
   in the list: <span class="org-verbatim">(car (cdr element))</span>.

<span class="org-list-dt">2.</span> <span class="org-verbatim">plist-get</span> finds the relevant strings in this second item. But
   this function returns not only the string, but several other
   properties. The string we need is at the head of the list, but this
   may be buried within several nested lists. So I wrote a function,
   <span class="org-verbatim">hjh-get-string-from-nested-thing</span>, that keeps stripping off "car"
   from the object, until it finds a string.

<span class="org-list-dt">3.</span> This string itself also includes formatting properties, so I had to
   use <span class="org-verbatim">substring-no-properties</span> on these items.

To generate the aggregate code file, then, I simply do <span class="org-verbatim">M-x
hjh-src-blocks-to-buffer</span>, type in the starting listing number for
this chapter, and in a few seconds, I get a buffer containing
SuperCollider code separated by comments holding the captions, e.g.:

<span class="org-block-begin-line">#+begin_src {SuperCollider} -i
</span>/**************
 Listing 6. A very simple synth.
 **************/

a = { SinOsc.ar(440, 0, 0.1).dup }.play;

// To make it stop:
a.release;
<span class="org-block-end-line">#+end_src
</span>
<span class="org-meta-line">#+name: extract</span>
<span class="org-meta-line">#+caption:</span> <span class="org-block">Emacs-lisp functions to find captioned source blocks within a buffer.</span>
<span class="org-block-begin-line">#+begin_src emacs-lisp -i
</span><span class="org-block"><span class="rainbow-delimiters-depth-1">(</span></span><span class="org-block"><span class="keyword">defun</span></span><span class="org-block"> </span><span class="org-block"><span class="function-name">hjh-get-string-from-nested-thing</span></span><span class="org-block"> </span><span class="org-block"><span class="rainbow-delimiters-depth-2">(</span></span><span class="org-block">thing</span><span class="org-block"><span class="rainbow-delimiters-depth-2">)</span></span><span class="org-block">
  </span><span class="org-block"><span class="doc">"Peel off 'car's from a nested list until the car is a string."</span></span><span class="org-block">
  </span><span class="org-block"><span class="rainbow-delimiters-depth-2">(</span></span><span class="org-block"><span class="keyword">while</span></span><span class="org-block"> </span><span class="org-block"><span class="rainbow-delimiters-depth-3">(</span></span><span class="org-block"><span class="keyword">and</span></span><span class="org-block"> thing </span><span class="org-block"><span class="rainbow-delimiters-depth-1">(</span></span><span class="org-block"><span class="constant">not</span></span><span class="org-block"> </span><span class="org-block"><span class="rainbow-delimiters-depth-2">(</span></span><span class="org-block"><span class="constant">stringp</span></span><span class="org-block"> thing</span><span class="org-block"><span class="rainbow-delimiters-depth-2">)</span></span><span class="org-block"><span class="rainbow-delimiters-depth-1">)</span></span><span class="org-block"><span class="rainbow-delimiters-depth-3">)</span></span><span class="org-block">
    </span><span class="org-block"><span class="rainbow-delimiters-depth-3">(</span></span><span class="org-block"><span class="keyword">setq</span></span><span class="org-block"> thing </span><span class="org-block"><span class="rainbow-delimiters-depth-1">(</span></span><span class="org-block"><span class="constant">car</span></span><span class="org-block"> thing</span><span class="org-block"><span class="rainbow-delimiters-depth-1">)</span></span><span class="org-block"><span class="rainbow-delimiters-depth-3">)</span></span><span class="org-block"><span class="rainbow-delimiters-depth-2">)</span></span><span class="org-block">
  thing
</span><span class="org-block"><span class="rainbow-delimiters-depth-1">)</span></span><span class="org-block">

</span><span class="org-block"><span class="rainbow-delimiters-depth-1">(</span></span><span class="org-block"><span class="keyword">defun</span></span><span class="org-block"> </span><span class="org-block"><span class="function-name">hjh-src-blocks-to-string</span></span><span class="org-block"> </span><span class="org-block"><span class="rainbow-delimiters-depth-2">(</span></span><span class="org-block">counter get-some</span><span class="org-block"><span class="rainbow-delimiters-depth-2">)</span></span><span class="org-block">
  </span><span class="org-block"><span class="doc">"Iterate src blocks from org-element and add them to a string."</span></span><span class="org-block">
  </span><span class="org-block"><span class="rainbow-delimiters-depth-2">(</span></span><span class="org-block"><span class="keyword">interactive</span></span><span class="org-block"> </span><span class="org-block"><span class="string">"nStarting listing number: \nP"</span></span><span class="org-block"><span class="rainbow-delimiters-depth-2">)</span></span><span class="org-block">
  </span><span class="org-block"><span class="rainbow-delimiters-depth-2">(</span></span><span class="org-block"><span class="keyword">when</span></span><span class="org-block"> </span><span class="org-block"><span class="rainbow-delimiters-depth-3">(</span></span><span class="org-block"><span class="constant">not</span></span><span class="org-block"> counter</span><span class="org-block"><span class="rainbow-delimiters-depth-3">)</span></span><span class="org-block"> </span><span class="org-block"><span class="rainbow-delimiters-depth-3">(</span></span><span class="org-block"><span class="keyword">setq</span></span><span class="org-block"> counter </span><span class="org-block"><span class="highlight-numbers-number">1</span></span><span class="org-block"><span class="rainbow-delimiters-depth-3">)</span></span><span class="org-block"><span class="rainbow-delimiters-depth-2">)</span></span><span class="org-block">
  </span><span class="org-block"><span class="rainbow-delimiters-depth-2">(</span></span><span class="org-block"><span class="keyword">let</span></span><span class="org-block"> </span><span class="org-block"><span class="rainbow-delimiters-depth-3">(</span></span><span class="org-block"><span class="rainbow-delimiters-depth-1">(</span></span><span class="org-block">tree </span><span class="org-block"><span class="rainbow-delimiters-depth-2">(</span></span><span class="org-block"><span class="function-name">org-element-parse-buffer</span></span><span class="org-block"><span class="rainbow-delimiters-depth-2">)</span></span><span class="org-block"><span class="rainbow-delimiters-depth-1">)</span></span><span class="org-block">
</span><span class="whitespace-tab">        </span><span class="org-block"><span class="rainbow-delimiters-depth-1">(</span></span><span class="org-block"><span class="constant">string</span></span><span class="org-block"> </span><span class="org-block"><span class="string">""</span></span><span class="org-block"><span class="rainbow-delimiters-depth-1">)</span></span><span class="org-block">
</span><span class="whitespace-tab">        </span><span class="org-block"><span class="rainbow-delimiters-depth-1">(</span></span><span class="org-block">get-all </span><span class="org-block"><span class="rainbow-delimiters-depth-2">(</span></span><span class="org-block"><span class="constant">not</span></span><span class="org-block"> get-some</span><span class="org-block"><span class="rainbow-delimiters-depth-2">)</span></span><span class="org-block"><span class="rainbow-delimiters-depth-1">)</span></span><span class="org-block"><span class="rainbow-delimiters-depth-3">)</span></span><span class="org-block">
    </span><span class="org-block"><span class="rainbow-delimiters-depth-3">(</span></span><span class="org-block"><span class="function-name">org-element-map</span></span><span class="org-block"> tree </span><span class="org-block"><span class="highlight-quoted-quote">'</span></span><span class="org-block"><span class="highlight-quoted-symbol">src-block</span></span><span class="org-block">
      </span><span class="org-block"><span class="rainbow-delimiters-depth-1">(</span></span><span class="org-block"><span class="keyword">lambda</span></span><span class="org-block"> </span><span class="org-block"><span class="rainbow-delimiters-depth-2">(</span></span><span class="org-block">element</span><span class="org-block"><span class="rainbow-delimiters-depth-2">)</span></span><span class="org-block">
</span><span class="whitespace-tab">        </span><span class="org-block"><span class="rainbow-delimiters-depth-2">(</span></span><span class="org-block"><span class="keyword">setq</span></span><span class="org-block"> element </span><span class="org-block"><span class="rainbow-delimiters-depth-3">(</span></span><span class="org-block"><span class="constant">car</span></span><span class="org-block"> </span><span class="org-block"><span class="rainbow-delimiters-depth-1">(</span></span><span class="org-block"><span class="constant">cdr</span></span><span class="org-block"> element</span><span class="org-block"><span class="rainbow-delimiters-depth-1">)</span></span><span class="org-block"><span class="rainbow-delimiters-depth-3">)</span></span><span class="org-block"><span class="rainbow-delimiters-depth-2">)</span></span><span class="org-block">
</span><span class="whitespace-tab">        </span><span class="org-block"><span class="rainbow-delimiters-depth-2">(</span></span><span class="org-block"><span class="keyword">let</span></span><span class="org-block"> </span><span class="org-block"><span class="rainbow-delimiters-depth-3">(</span></span><span class="org-block"><span class="rainbow-delimiters-depth-1">(</span></span><span class="org-block">caption </span><span class="org-block"><span class="rainbow-delimiters-depth-2">(</span></span><span class="org-block">hjh-get-string-from-nested-thing </span><span class="org-block"><span class="rainbow-delimiters-depth-3">(</span></span><span class="org-block"><span class="constant">plist-get</span></span><span class="org-block"> element </span><span class="org-block"><span class="builtin">:caption</span></span><span class="org-block"><span class="rainbow-delimiters-depth-3">)</span></span><span class="org-block"><span class="rainbow-delimiters-depth-2">)</span></span><span class="org-block"><span class="rainbow-delimiters-depth-1">)</span></span><span class="org-block">
</span><span class="whitespace-tab">        </span><span class="org-block">      </span><span class="org-block"><span class="rainbow-delimiters-depth-1">(</span></span><span class="org-block">source </span><span class="org-block"><span class="rainbow-delimiters-depth-2">(</span></span><span class="org-block">hjh-get-string-from-nested-thing </span><span class="org-block"><span class="rainbow-delimiters-depth-3">(</span></span><span class="org-block"><span class="constant">plist-get</span></span><span class="org-block"> element </span><span class="org-block"><span class="builtin">:value</span></span><span class="org-block"><span class="rainbow-delimiters-depth-3">)</span></span><span class="org-block"><span class="rainbow-delimiters-depth-2">)</span></span><span class="org-block"><span class="rainbow-delimiters-depth-1">)</span></span><span class="org-block"><span class="rainbow-delimiters-depth-3">)</span></span><span class="org-block">
</span><span class="whitespace-tab">        </span><span class="org-block">  </span><span class="org-block"><span class="rainbow-delimiters-depth-3">(</span></span><span class="org-block"><span class="keyword">when</span></span><span class="org-block"> caption
</span><span class="whitespace-tab">        </span><span class="org-block">    </span><span class="org-block"><span class="rainbow-delimiters-depth-1">(</span></span><span class="org-block"><span class="keyword">when</span></span><span class="org-block"> </span><span class="org-block"><span class="rainbow-delimiters-depth-2">(</span></span><span class="org-block"><span class="keyword">or</span></span><span class="org-block"> get-all 
</span><span class="whitespace-tab">                </span><span class="org-block">      </span><span class="org-block"><span class="rainbow-delimiters-depth-3">(</span></span><span class="org-block"><span class="keyword">let</span></span><span class="org-block"> </span><span class="org-block"><span class="rainbow-delimiters-depth-1">(</span></span><span class="org-block"><span class="rainbow-delimiters-depth-2">(</span></span><span class="org-block">parms
</span><span class="whitespace-tab">                        </span><span class="org-block">     </span><span class="org-block"><span class="rainbow-delimiters-depth-3">(</span></span><span class="org-block">hjh-get-string-from-nested-thing </span><span class="org-block"><span class="rainbow-delimiters-depth-1">(</span></span><span class="org-block"><span class="constant">plist-get</span></span><span class="org-block"> element </span><span class="org-block"><span class="builtin">:parameters</span></span><span class="org-block"><span class="rainbow-delimiters-depth-1">)</span></span><span class="org-block"><span class="rainbow-delimiters-depth-3">)</span></span><span class="org-block"><span class="rainbow-delimiters-depth-2">)</span></span><span class="org-block"><span class="rainbow-delimiters-depth-1">)</span></span><span class="org-block">
</span><span class="whitespace-tab">                        </span><span class="org-block"><span class="rainbow-delimiters-depth-1">(</span></span><span class="org-block"><span class="keyword">and</span></span><span class="org-block"> </span><span class="org-block"><span class="rainbow-delimiters-depth-2">(</span></span><span class="org-block"><span class="constant">stringp</span></span><span class="org-block"> parms</span><span class="org-block"><span class="rainbow-delimiters-depth-2">)</span></span><span class="org-block"> </span><span class="org-block"><span class="rainbow-delimiters-depth-2">(</span></span><span class="org-block"><span class="function-name">string-match-p</span></span><span class="org-block"> </span><span class="org-block"><span class="string">"extract"</span></span><span class="org-block"> parms</span><span class="org-block"><span class="rainbow-delimiters-depth-2">)</span></span><span class="org-block"><span class="rainbow-delimiters-depth-1">)</span></span><span class="org-block"><span class="rainbow-delimiters-depth-3">)</span></span><span class="org-block"><span class="rainbow-delimiters-depth-2">)</span></span><span class="org-block">
</span><span class="whitespace-tab">        </span><span class="org-block">      </span><span class="org-block"><span class="rainbow-delimiters-depth-2">(</span></span><span class="org-block"><span class="keyword">setq</span></span><span class="org-block"> string </span><span class="org-block"><span class="rainbow-delimiters-depth-3">(</span></span><span class="org-block"><span class="constant">concat</span></span><span class="org-block"> string </span><span class="org-block"><span class="rainbow-delimiters-depth-1">(</span></span><span class="org-block"><span class="constant">format</span></span><span class="org-block"> </span><span class="org-block"><span class="string">"/**************
 Listing %d. %s
 **************/

%s\n\n"</span></span><span class="org-block">
</span><span class="whitespace-tab">                                        </span><span class="org-block">  counter
</span><span class="whitespace-tab">                                        </span><span class="org-block">  </span><span class="org-block"><span class="rainbow-delimiters-depth-2">(</span></span><span class="org-block"><span class="constant">substring-no-properties</span></span><span class="org-block"> caption</span><span class="org-block"><span class="rainbow-delimiters-depth-2">)</span></span><span class="org-block">
</span><span class="whitespace-tab">                                        </span><span class="org-block">  </span><span class="org-block"><span class="rainbow-delimiters-depth-2">(</span></span><span class="org-block"><span class="constant">substring-no-properties</span></span><span class="org-block"> source</span><span class="org-block"><span class="rainbow-delimiters-depth-2">)</span></span><span class="org-block"><span class="rainbow-delimiters-depth-1">)</span></span><span class="org-block"><span class="rainbow-delimiters-depth-3">)</span></span><span class="org-block"><span class="rainbow-delimiters-depth-2">)</span></span><span class="org-block"><span class="rainbow-delimiters-depth-1">)</span></span><span class="org-block">
</span><span class="whitespace-tab">        </span><span class="org-block">    </span><span class="org-block"><span class="comment-delimiter">; </span></span><span class="org-block"><span class="comment">always increment if there was a caption
</span></span><span class="whitespace-tab">        </span><span class="org-block">    </span><span class="org-block"><span class="rainbow-delimiters-depth-1">(</span></span><span class="org-block"><span class="keyword">setq</span></span><span class="org-block"> counter </span><span class="org-block"><span class="rainbow-delimiters-depth-2">(</span></span><span class="org-block"><span class="constant">1+</span></span><span class="org-block"> counter</span><span class="org-block"><span class="rainbow-delimiters-depth-2">)</span></span><span class="org-block"><span class="rainbow-delimiters-depth-1">)</span></span><span class="org-block"><span class="rainbow-delimiters-depth-3">)</span></span><span class="org-block"><span class="rainbow-delimiters-depth-2">)</span></span><span class="org-block"><span class="rainbow-delimiters-depth-1">)</span></span><span class="org-block"><span class="rainbow-delimiters-depth-3">)</span></span><span class="org-block">
    string</span><span class="org-block"><span class="rainbow-delimiters-depth-2">)</span></span><span class="org-block"><span class="rainbow-delimiters-depth-1">)</span></span><span class="org-block">

</span><span class="org-block"><span class="rainbow-delimiters-depth-1">(</span></span><span class="org-block"><span class="keyword">defun</span></span><span class="org-block"> </span><span class="org-block"><span class="function-name">hjh-src-blocks-to-buffer</span></span><span class="org-block"> </span><span class="org-block"><span class="rainbow-delimiters-depth-2">(</span></span><span class="org-block">counter get-some</span><span class="org-block"><span class="rainbow-delimiters-depth-2">)</span></span><span class="org-block">
  </span><span class="org-block"><span class="doc">"Put all the captioned source blocks from a buffer into another buffer."</span></span><span class="org-block">
  </span><span class="org-block"><span class="rainbow-delimiters-depth-2">(</span></span><span class="org-block"><span class="keyword">interactive</span></span><span class="org-block"> </span><span class="org-block"><span class="string">"nStarting listing number: \nP"</span></span><span class="org-block"><span class="rainbow-delimiters-depth-2">)</span></span><span class="org-block">
  </span><span class="org-block"><span class="rainbow-delimiters-depth-2">(</span></span><span class="org-block"><span class="keyword">let*</span></span><span class="org-block"> </span><span class="org-block"><span class="rainbow-delimiters-depth-3">(</span></span><span class="org-block"><span class="rainbow-delimiters-depth-1">(</span></span><span class="org-block">contents </span><span class="org-block"><span class="rainbow-delimiters-depth-2">(</span></span><span class="org-block">hjh-src-blocks-to-string counter get-some</span><span class="org-block"><span class="rainbow-delimiters-depth-2">)</span></span><span class="org-block"><span class="rainbow-delimiters-depth-1">)</span></span><span class="org-block">
</span><span class="whitespace-tab">        </span><span class="org-block"> </span><span class="org-block"><span class="rainbow-delimiters-depth-1">(</span></span><span class="org-block">bufpath </span><span class="org-block"><span class="rainbow-delimiters-depth-2">(</span></span><span class="org-block"><span class="variable-name">buffer-file-name</span></span><span class="org-block"><span class="rainbow-delimiters-depth-2">)</span></span><span class="org-block"><span class="rainbow-delimiters-depth-1">)</span></span><span class="org-block">
</span><span class="whitespace-tab">        </span><span class="org-block"> </span><span class="org-block"><span class="rainbow-delimiters-depth-1">(</span></span><span class="org-block">newname </span><span class="org-block"><span class="rainbow-delimiters-depth-2">(</span></span><span class="org-block"><span class="constant">concat</span></span><span class="org-block"> </span><span class="org-block"><span class="rainbow-delimiters-depth-3">(</span></span><span class="org-block"><span class="function-name">file-name-sans-extension</span></span><span class="org-block"> bufpath</span><span class="org-block"><span class="rainbow-delimiters-depth-3">)</span></span><span class="org-block"> </span><span class="org-block"><span class="string">".scd"</span></span><span class="org-block"><span class="rainbow-delimiters-depth-2">)</span></span><span class="org-block"><span class="rainbow-delimiters-depth-1">)</span></span><span class="org-block">
</span><span class="whitespace-tab">        </span><span class="org-block"> </span><span class="org-block"><span class="rainbow-delimiters-depth-1">(</span></span><span class="org-block">bufname </span><span class="org-block"><span class="rainbow-delimiters-depth-2">(</span></span><span class="org-block"><span class="constant">file-name-nondirectory</span></span><span class="org-block"> newname</span><span class="org-block"><span class="rainbow-delimiters-depth-2">)</span></span><span class="org-block"><span class="rainbow-delimiters-depth-1">)</span></span><span class="org-block">
</span><span class="whitespace-tab">        </span><span class="org-block"> </span><span class="org-block"><span class="rainbow-delimiters-depth-1">(</span></span><span class="org-block">newbuf </span><span class="org-block"><span class="rainbow-delimiters-depth-2">(</span></span><span class="org-block"><span class="constant">get-buffer-create</span></span><span class="org-block"> bufname</span><span class="org-block"><span class="rainbow-delimiters-depth-2">)</span></span><span class="org-block"><span class="rainbow-delimiters-depth-1">)</span></span><span class="org-block"><span class="rainbow-delimiters-depth-3">)</span></span><span class="org-block">
    </span><span class="org-block"><span class="rainbow-delimiters-depth-3">(</span></span><span class="org-block"><span class="keyword">with-current-buffer</span></span><span class="org-block"> newbuf
      </span><span class="org-block"><span class="rainbow-delimiters-depth-1">(</span></span><span class="org-block"><span class="constant">erase-buffer</span></span><span class="org-block"><span class="rainbow-delimiters-depth-1">)</span></span><span class="org-block">
      </span><span class="org-block"><span class="rainbow-delimiters-depth-1">(</span></span><span class="org-block"><span class="constant">insert</span></span><span class="org-block"> contents</span><span class="org-block"><span class="rainbow-delimiters-depth-1">)</span></span><span class="org-block">
      </span><span class="org-block"><span class="rainbow-delimiters-depth-1">(</span></span><span class="org-block"><span class="function-name">set-visited-file-name</span></span><span class="org-block"> newname</span><span class="org-block"><span class="rainbow-delimiters-depth-1">)</span></span><span class="org-block"><span class="rainbow-delimiters-depth-3">)</span></span><span class="org-block">
    </span><span class="org-block"><span class="rainbow-delimiters-depth-3">(</span></span><span class="org-block"><span class="function-name">switch-to-buffer-other-window</span></span><span class="org-block"> newbuf</span><span class="org-block"><span class="rainbow-delimiters-depth-3">)</span></span><span class="org-block"><span class="rainbow-delimiters-depth-2">)</span></span><span class="org-block"><span class="rainbow-delimiters-depth-1">)</span></span><span class="org-block">
</span><span class="org-block-end-line">#+end_src
</span>
<span class="comment"># #+begin_comment</span>
<span class="comment"># #+name: </span>
<span class="comment"># #+caption: </span>
<span class="comment"># #+begin_src org</span>
<span class="comment"># #+end_src</span>
<span class="comment"># #+end_comment</span>

<span class="org-superstar-leading">*</span><span class="org-level-2"><span class="org-superstar-header-bullet">*</span></span><span class="org-level-2"> Partitioning the article export
</span>Rather than create a document class to turn top-level headings into <span class="org-verbatim">\part</span> 
commands, I embedded the LaTeX code for it directly into the full-article 
template. The trick is closing the environments for the previous sections. 
This requires a top-level heading, which should not start a new section. I 
found that <span class="org-verbatim">:B_ignoreheading:</span> did not work for this, but an <span class="kc-org-link-url"><a href="http://stackoverflow.com/questions/10295177/is-there-an-equivalent-of-org-modes-b-ignoreheading-for-non-beamer-documents">export filter</a></span>
by Suvayu Ali did exactly what I needed.

<span class="org-meta-line">#+name: articleParts</span>
<span class="org-meta-line">#+caption:</span> <span class="org-block">Part of the full-article export document, with embedded LaTeX \part syntax.</span>
<span class="org-block-begin-line">#+begin_src org
</span><span class="org-block">  ,#+startup: beamer
  
  ,#+TITLE: Workshop: Synthesis and Performance in SuperCollider
  ,#+DATE: \today
  ,#+AUTHOR: H. James Harkins
  
  ,#+INCLUDE: "../printhead2.org"
  ,#+include: "../glossary.org"
  ,* Part 1                                                      :ignoreheading:
  ,#+latex: \clearpage\part{Introductory SC, Synthesis and Sequencing}
  ,#+include: "../01-intro/01-contents.org" :minlevel 1
  
  ,* Part 2                                                      :ignoreheading:
  ,#+latex: \clearpage\part{Sequencing with Patterns; Synthesis Techniques}
  ,#+include: "../02-synth/02-contents.org" :minlevel 1
</span><span class="org-block-end-line">#+end_src
</span>
<span class="org-level-1"><span class="org-superstar-header-bullet">*</span></span><span class="org-level-1"> Weaknesses
</span><span class="org-superstar-leading">*</span><span class="org-level-2"><span class="org-superstar-header-bullet">*</span></span><span class="org-level-2"> Reliance on LaTeX-specific markup
</span>
One significant problem, which this project did not attempt to solve,
is to reconcile the LaTeX's <span class="italic">semantic markup</span> with org's ideal of
backend-independent markup. In LaTeX, it's common to define different
markup commands for different types of text. This project, for
instance, uses <span class="org-verbatim">\cd{}</span> for in-line code snippets and <span class="org-verbatim">\ci{}</span> for code
keywords and identifiers. Both render in the monospace font, in the
same color; by marking them up differently, I can easily change the
formatting of one or the other by changing the command's
definition. (In fact, there is a slight difference: <span class="org-verbatim">\ci</span> identifiers
are put into an <span class="org-verbatim">\mbox</span>, to suppress hyphenation.)

Org's formatting markup is visual: asterisks for bold, slashes for
italics and so on.

I think <span class="kc-org-link-url"><a href="https://orgmode.org/manual/Macro-replacement.html#Macro-replacement">export macros</a></span> could support semantic markup that could export
to LaTeX or HTML equally well, but I didn't investigate that in this
project. Here, I just embedded LaTeX commands directly into the org
files: free standing for simple uses, and using export snippets<span class="org-footnote">[fn:448d1164]</span> for
more intricate cases (such as code examples including curly braces,
which LaTeX export treats specially).

<span class="org-level-1"><span class="org-superstar-header-bullet">*</span></span><span class="org-level-1"> Footnotes
</span>
<span class="org-footnote">[fn:448d1164]</span> Export snippets look like this:
<span class="org-verbatim">@@backendname:text...@@</span>. They will export only to that backend. You
can write several of them in a row for different backends:
<span class="org-verbatim">@@latex:\emph{italic}@@@@html:&lt;i&gt;italic&lt;/i&gt;@@</span> and each export style
receives the right snippet.

</pre>
  </body>
</html>
